<script setup lang="ts">
import type { Album } from '../../store/album'
import { onClickOutside } from '@vueuse/core'
import { computed, ref } from 'vue'
import { useAlbums } from '../../store/album'
import { useLoading } from '../../store/loading'

interface Props {
  data: Album
}

const props = defineProps<Props>()
const albums = useAlbums()
const { getLoading } = useLoading()
const open = ref(false)
const wrap = ref(null)

onClickOutside(wrap, () => {
  open.value = false
})

const timestamp = computed(() => {
  const d = new Date(props.data.publishedAt * 1000)
  return d.toLocaleDateString('en-GB', {
    year: 'numeric',
    month: 'numeric',
    day: 'numeric',
  })
})

async function deleteDraft() {
  await albums.deleteAlbum(props.data.key)
  albums.fetchDrafts()
}
</script>

<template>
  <div class="draft">
    <strong :title="props.data.title">{{ props.data.title }}</strong>
    <p>Created: {{ timestamp }}</p>

    <!-- This div does nothing but enforce a boundary for outside clicking detection -->
    <div ref="wrap">
      <button class="hover-bubble dropdown-button" :class="{ active: open }" @click="open = !open">
        <!-- <span class="material-icons"> &#xe5d2; </span> -->
        <span class="material-icons"> &#xe5d4; </span>
      </button>

      <div class="dropdown-list" :class="{ active: open }">
        <router-link :to="{ name: 'AlbumDetail', params: { id: props.data.key } }" class="hover-bubble">
          <span class="material-icons">&#xe3b6;</span>
          View
        </router-link>

        <router-link :to="{ name: 'AlbumEdit', params: { id: props.data.key } }" class="hover-bubble bubble-info">
          <span class="material-icons">&#xe3c9;</span>
          Edit
        </router-link>

        <button
          class="hover-bubble bubble-red"
          :class="{ 'btn-disabled': getLoading('delete-album') }"
          @click="deleteDraft"
        >
          <span class="material-icons"> &#xe872; </span>

          Delete

          <span v-if="getLoading('delete-album')" class="material-icons rotate">&#xe863;</span>
        </button>
      </div>
    </div>
  </div>
</template>
